# ðŸš€ Complete Deployment Guide: Supabase + Render + Vercel

## ðŸ“‹ Table of Contents
1. [Overview](#overview)
2. [Part 1: Setting Up Supabase Database](#part-1-setting-up-supabase-database)
3. [Part 2: Deploying Backend to Render](#part-2-deploying-backend-to-render)
4. [Part 3: Connecting Frontend on Vercel](#part-3-connecting-frontend-on-vercel)
5. [Part 4: Testing the Complete Stack](#part-4-testing-the-complete-stack)
6. [Troubleshooting](#troubleshooting)

---

## Overview

**Your Stack:**
- **Frontend**: Vercel (Already deployed âœ…)
- **Backend**: Render (To be deployed)
- **Database**: Supabase PostgreSQL (To be configured)

**Architecture:**
```
Vercel (Frontend) â†’ Render (Backend API) â†’ Supabase (PostgreSQL Database)
```

---

## Part 1: Setting Up Supabase Database

### Step 1.1: Create a Supabase Account and Project

1. **Go to Supabase**: Visit [https://supabase.com](https://supabase.com)
2. **Sign Up/Login**: Use GitHub, Google, or email
3. **Create New Project**:
   - Click **"New Project"**
   - **Organization**: Select or create one
   - **Project Name**: `portfolio-database` (or your preferred name)
   - **Database Password**: Generate a strong password and **SAVE IT SECURELY** ðŸ”’
   - **Region**: Choose closest to your users (e.g., `us-east-1`)
   - Click **"Create new project"**

4. **Wait for Setup**: This takes 1-2 minutes

### Step 1.2: Get Your Database Connection String

1. **Navigate to Settings**:
   - Click on the **Settings** icon (âš™ï¸) in the left sidebar
   - Select **"Database"**

2. **Find Connection String**:
   - Scroll to **"Connection string"** section
   - Select **"URI"** tab
   - Copy the connection string that looks like:
   ```
   postgresql://postgres:[YOUR-PASSWORD]@db.xxx.supabase.co:5432/postgres
   ```

3. **Important**: Replace `[YOUR-PASSWORD]` with the actual password you set during project creation

4. **Connection Pooling (Recommended for Production)**:
   - Scroll to **"Connection pooling"** section
   - Copy the **pooler connection string** (for better performance):
   ```
   postgresql://postgres.[PROJECT-REF]:[YOUR-PASSWORD]@aws-0-[REGION].pooler.supabase.com:6543/postgres
   ```
   - **Use this pooler string for Render!**

### Step 1.3: Set Up Database Tables

**Option A: Using Supabase SQL Editor (Recommended)**

1. Click on **SQL Editor** in the left sidebar
2. Click **"New query"**
3. Copy and paste the contents of `/backend/database/schema.sql`
4. Click **"Run"** or press `Ctrl+Enter`
5. Verify tables were created:
   ```sql
   SELECT tablename FROM pg_tables WHERE schemaname = 'public';
   ```

**Option B: Using Local psql Client**

```bash
# Install PostgreSQL client if not installed
# Ubuntu/Debian:
sudo apt-get install postgresql-client

# macOS:
brew install postgresql

# Connect to Supabase
psql "postgresql://postgres:[PASSWORD]@db.xxx.supabase.co:5432/postgres"

# Run schema file
\i backend/database/schema.sql
```

### Step 1.4: Create Admin User (After Backend Deployment)

You'll run this after deploying to Render:
```bash
# SSH into Render or use Render Shell
node setup-super-admin.js
```

---

## Part 2: Deploying Backend to Render

### Step 2.1: Prepare Your Repository

1. **Ensure your code is pushed to GitHub**:
   ```bash
   cd backend
   git add .
   git commit -m "Convert to PostgreSQL for Supabase"
   git push origin main
   ```

2. **Verify `.gitignore` includes**:
   ```
   node_modules/
   .env
   .env.local
   ```

### Step 2.2: Create Render Account and Web Service

1. **Go to Render**: Visit [https://render.com](https://render.com)
2. **Sign Up/Login**: Connect with GitHub
3. **New Web Service**:
   - Click **"New +"** â†’ **"Web Service"**
   - Connect your GitHub repository: `PERSONAL_PORTIFOLIO`
   - Click **"Connect"**

### Step 2.3: Configure Web Service

**Basic Settings:**
- **Name**: `portfolio-backend` (or your preferred name)
- **Region**: Same as Supabase (e.g., `Oregon (US West)` or `Ohio (US East)`)
- **Branch**: `main`
- **Root Directory**: `backend`
- **Runtime**: `Node`
- **Build Command**: 
  ```bash
  npm install
  ```
- **Start Command**: 
  ```bash
  npm start
  ```

**Instance Type:**
- Select **"Free"** (or paid plan for better performance)

### Step 2.4: Configure Environment Variables

Click on **"Environment"** tab and add these variables:

```bash
# Node Environment
NODE_ENV=production

# Database Configuration (USE POOLER CONNECTION STRING!)
DATABASE_URL=postgresql://postgres.[PROJECT-REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:6543/postgres

# JWT Secret (Generate a strong random string)
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# Session Secret (Generate a strong random string)
SESSION_SECRET=your-super-secret-session-key-change-this-in-production

# Frontend URL (Your Vercel deployment)
FRONTEND_URL=https://your-portfolio.vercel.app

# Backend URL (Will be auto-generated by Render)
# Format: https://portfolio-backend.onrender.com
BACKEND_URL=https://portfolio-backend.onrender.com

# Email Configuration (Optional - for contact form notifications)
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-specific-password
EMAIL_FROM=your-email@gmail.com
EMAIL_TO=your-email@gmail.com

# SMTP Configuration (if using custom SMTP)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587

# CORS Origins (Your Vercel domain)
CORS_ORIGINS=https://your-portfolio.vercel.app,https://your-custom-domain.com

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
```

**How to Generate Secure Secrets:**
```bash
# In your terminal:
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### Step 2.5: Deploy

1. Click **"Create Web Service"**
2. Render will automatically:
   - Clone your repository
   - Install dependencies
   - Start your server
3. **Wait for deployment** (5-10 minutes for first deploy)
4. You'll get a URL like: `https://portfolio-backend.onrender.com`

### Step 2.6: Initialize Database Tables

**Option 1: Using Render Shell**
1. Go to your service dashboard
2. Click **"Shell"** tab
3. Run:
   ```bash
   node config/init-database.js
   ```

**Option 2: Already done in Supabase SQL Editor**
If you ran the schema.sql in Supabase, skip this step.

### Step 2.7: Create Super Admin User

1. In Render Shell or via SSH:
   ```bash
   node setup-super-admin.js
   ```

2. Follow the prompts to create your admin account

---

## Part 3: Connecting Frontend on Vercel

### Step 3.1: Update Frontend Environment Variables

1. **Go to Vercel Dashboard**: [https://vercel.com](https://vercel.com)
2. **Select your portfolio project**
3. **Go to Settings** â†’ **Environment Variables**

### Step 3.2: Add/Update Variables

```bash
# Backend API URL (Your Render deployment)
VITE_API_URL=https://portfolio-backend.onrender.com
VITE_BACKEND_URL=https://portfolio-backend.onrender.com

# API Base URL
VITE_API_BASE_URL=https://portfolio-backend.onrender.com/api

# Environment
VITE_NODE_ENV=production
```

### Step 3.3: Update Frontend Code (if needed)

**Check your API configuration file** (usually `src/config/api.js` or similar):

```javascript
// src/config/api.js
const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:5000';

export const config = {
  apiUrl: API_URL,
  endpoints: {
    contact: `${API_URL}/api/contact`,
    login: `${API_URL}/api/auth/login`,
    // ... other endpoints
  }
};

export default config;
```

### Step 3.4: Redeploy Frontend

1. **Trigger Redeploy**:
   - In Vercel Dashboard â†’ **Deployments**
   - Click **"Redeploy"** on latest deployment
   - Or push a new commit to trigger auto-deploy

2. **Wait for deployment** (1-2 minutes)

---

## Part 4: Testing the Complete Stack

### Step 4.1: Test Backend Health

```bash
# Test if backend is running
curl https://portfolio-backend.onrender.com/health

# Expected response:
# {"status":"ok","timestamp":"..."}
```

### Step 4.2: Test Database Connection

```bash
# Test database connectivity
curl https://portfolio-backend.onrender.com/api/test-db

# Or check Render logs
```

### Step 4.3: Test Contact Form

1. **Visit your frontend**: `https://your-portfolio.vercel.app`
2. **Navigate to contact section**
3. **Submit a test message**
4. **Check**:
   - Network tab in browser DevTools
   - Render logs for incoming requests
   - Supabase Database â†’ Table Editor â†’ `contacts` table

### Step 4.4: Test Admin Login

1. **Navigate to**: `https://your-portfolio.vercel.app/admin/login`
2. **Login with credentials** created in Step 2.7
3. **Verify**: You can access admin dashboard

---

## Part 5: Enable CORS Properly

### Step 5.1: Update Backend CORS Configuration

Ensure your `server.js` has proper CORS setup:

```javascript
// backend/server.js
const cors = require('cors');

const corsOptions = {
  origin: [
    'https://your-portfolio.vercel.app',
    'https://your-custom-domain.com',
    process.env.FRONTEND_URL
  ],
  credentials: true,
  optionsSuccessStatus: 200,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
};

app.use(cors(corsOptions));
```

---

## Part 6: Security Checklist

### âœ… Essential Security Steps

- [ ] **Strong JWT Secret**: Used a 32+ character random string
- [ ] **Strong Session Secret**: Different from JWT secret
- [ ] **Database Password**: Strong and never committed to Git
- [ ] **Environment Variables**: Set in Render, never in code
- [ ] **HTTPS Only**: Both Render and Vercel use HTTPS
- [ ] **CORS Configured**: Only allows your Vercel domain
- [ ] **Rate Limiting**: Enabled in backend
- [ ] **SQL Injection Protection**: Using parameterized queries
- [ ] **XSS Protection**: Helmet middleware enabled

---

## Part 7: Performance Optimization

### Enable Connection Pooling

Your `config/database.js` already uses pooling:
```javascript
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: { rejectUnauthorized: false },
  max: 10, // Maximum 10 connections
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});
```

### Optimize Render Cold Starts

**Add a cron job to keep service warm** (Render Free tier sleeps after inactivity):

1. Use a service like **UptimeRobot** or **Cron-job.org**
2. Ping your backend every 5-10 minutes:
   ```
   https://portfolio-backend.onrender.com/health
   ```

---

## Troubleshooting

### Issue 1: "Cannot connect to database"

**Solution:**
1. Verify DATABASE_URL in Render environment variables
2. Check Supabase project is not paused
3. Ensure you're using the pooler connection string
4. Test connection:
   ```bash
   # In Render Shell
   node -e "const {pool} = require('./config/database'); pool.query('SELECT NOW()').then(r => console.log(r.rows)).catch(console.error)"
   ```

### Issue 2: "CORS Error" in Frontend

**Solution:**
1. Check `FRONTEND_URL` in Render env vars matches your Vercel URL exactly
2. Verify CORS configuration in `server.js`
3. Clear browser cache and cookies
4. Check browser console for exact CORS error

### Issue 3: "502 Bad Gateway" on Render

**Solution:**
1. Check Render logs for errors
2. Verify `package.json` has correct start script
3. Ensure port binding:
   ```javascript
   const PORT = process.env.PORT || 5000;
   ```
4. Check build completed successfully

### Issue 4: "Database tables don't exist"

**Solution:**
1. Run schema.sql in Supabase SQL Editor
2. Or run in Render Shell:
   ```bash
   node config/init-database.js
   ```

### Issue 5: "Cannot create admin user"

**Solution:**
1. Verify tables exist in Supabase
2. Check DATABASE_URL connection
3. Run setup script in Render Shell:
   ```bash
   node setup-super-admin.js
   ```

### Issue 6: Render Service Keeps Sleeping (Free Tier)

**Solution:**
1. Use a keep-alive service (UptimeRobot, Cron-job.org)
2. Upgrade to Render paid plan ($7/month)
3. Accept 30-60 second cold start delay

---

## Monitoring and Logs

### View Render Logs
1. Go to Render Dashboard
2. Select your service
3. Click **"Logs"** tab
4. Filter by time range or search terms

### View Supabase Logs
1. Go to Supabase Dashboard
2. Select your project
3. Click **"Logs"** â†’ **"Postgres Logs"**

### Check Frontend Errors
1. Go to Vercel Dashboard
2. Select deployment
3. Click **"Functions"** â†’ **"Logs"**

---

## Quick Reference

### Important URLs
```
Frontend:      https://your-portfolio.vercel.app
Backend:       https://portfolio-backend.onrender.com
Admin Panel:   https://your-portfolio.vercel.app/admin
Supabase:      https://supabase.com/dashboard
Render:        https://dashboard.render.com
Vercel:        https://vercel.com/dashboard
```

### Environment Variables Template

**Render (.env equivalent):**
```bash
NODE_ENV=production
DATABASE_URL=postgresql://postgres.[REF]:[PASS]@aws-0-[REGION].pooler.supabase.com:6543/postgres
JWT_SECRET=generate-32-char-random-string
SESSION_SECRET=generate-32-char-random-string
FRONTEND_URL=https://your-portfolio.vercel.app
BACKEND_URL=https://portfolio-backend.onrender.com
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
EMAIL_FROM=your-email@gmail.com
EMAIL_TO=your-email@gmail.com
CORS_ORIGINS=https://your-portfolio.vercel.app
```

**Vercel (.env equivalent):**
```bash
VITE_API_URL=https://portfolio-backend.onrender.com
VITE_BACKEND_URL=https://portfolio-backend.onrender.com
VITE_API_BASE_URL=https://portfolio-backend.onrender.com/api
VITE_NODE_ENV=production
```

---

## Next Steps After Deployment

1. **Set up domain**: Configure custom domain in Vercel
2. **Enable email notifications**: Configure SMTP in Render
3. **Set up backups**: Enable Supabase daily backups
4. **Add monitoring**: Set up UptimeRobot or similar
5. **SSL Certificate**: Auto-handled by Render and Vercel
6. **Analytics**: Add Google Analytics or Plausible

---

## Cost Breakdown

| Service | Free Tier | Paid Tier |
|---------|-----------|-----------|
| **Supabase** | 500MB database, 2GB bandwidth | $25/month (8GB database, 50GB bandwidth) |
| **Render** | 750 hours/month, sleeps after 15min | $7/month (always on) |
| **Vercel** | 100GB bandwidth, unlimited sites | $20/month (Pro) |

**Total Free Tier**: $0/month âœ…
**Total Minimum Paid**: $7-32/month

---

## Support and Resources

- **Supabase Docs**: https://supabase.com/docs
- **Render Docs**: https://render.com/docs
- **Vercel Docs**: https://vercel.com/docs
- **PostgreSQL Docs**: https://www.postgresql.org/docs

---

**ðŸŽ‰ Congratulations!** Your full-stack portfolio is now deployed with:
- âœ… Frontend on Vercel
- âœ… Backend on Render
- âœ… Database on Supabase
- âœ… HTTPS Everywhere
- âœ… Production Ready

---

*Last Updated: October 15, 2025*
